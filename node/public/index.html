<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grover</title>
  <link rel="shortcut icon" type="image/png" href="/public/Images/favicon.png"/>
  <!-- Latest compiled and minified CSS & JS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>


</head>
<body>
    <header>
         <nav class="navbar navbar-light" style="background-color: #28a745;">
             <div class="container d-flex justify-content-between">
                <a  class="navbar-brand d-flex align-items-center" >
          
                  <h3 class = "text-white" font-size = "12">ROCR</h3>
                </a>
              </div>
          </nav>

      </header>

      <br>
      <br>
      <div class="container">
        <div class="row">

          <div class="col d-flex justify-content-center text-center">
            <div class="card" style="width: 25rem;">
              <div class="card-body">
                <h5 class="text-center">File Upload</h5>
                <p class="card-text">Click Here to Upload a File</p>
      
                <form id ="file-form"> 
                  <input id="file-name" name="foo" type="file"> 
                  <hr>
                  <input class="btn btn-success" id="add-data" type="submit" value="Submit">


              </form> 

              </div>
            </div>
          </div>

                </div>
              </div>
            </div> 

        </div>
      </div>

  <script>

$.ajaxSetup({
  beforeSend:function(jqXHR,settings){
    if (settings.dataType === 'binary'){
      settings.xhr().responseType='arraybuffer';
      settings.processData=false;
    }
  }
})

    var pdfName;
    var csvName;
    var pngName;

    $("#file-form").on("submit", function(event) {
    event.preventDefault() 
    var filePath = $("#file-name").val();
        pngName = filePath.replace(/^.*[\\\/]/, '');
        csvName = pngName.slice(0,-3)+"csv"
        pdfName = pngName.slice(0,-3)+"pdf"

    var formData = new FormData(this);

    $.ajax({
        url: "http://104.248.69.73:8080/pdfpost",
        type: 'POST',
        data: formData,
        async: false,
        cache: false,
        contentType: false,
        processData: false,
        success: function () {
            alert('File Submitted!');
        }

    }).then(ocr())
});


function ocr() {
  
  $.ajax({
        url: "http://104.248.69.73:8080/ocr?filename="+pngName,
        type: 'GET',
        dataType: 'text',
        async: false,
        success: function () {
            console.log("ocr in progress");
        }
      }).then(makecsv())
}


function makecsv() {
  
  $.ajax({
        url: "http://104.248.69.73:4000/tabcsv?pdf="+pdfName,
        type: 'GET',
        dataType: 'text',
        async: false,
        success: function () {
            console.log("grabbing "+pdfName);
        }
      // }).then(window.open("/csvgrab?filename="+csvName) && setTimeout(function(){ deleteall(); }, 10000))
    }).then(postfile(deleteall))



}

function postfile(callback) {
  window.open("/csvgrab?filename="+csvName)

  if (window.closed = false) {
    deleteall()
  }
}

function deleteall() {
  
  $.ajax({
        url: "http://104.248.69.73:8080/delete?filename="+csvName,
        type: 'GET',
        dataType: 'text',
        async: false,
        success: function () {
            console.log("deleted all");
        }
      }).then(csvName = "", pdfName = "", pngName = "")
}

// function getcsv() {
//   $.ajax({
//         url: "http://104.248.69.73:8080/csvgrab?filename="+"tableTEST.csv",
//         type: 'GET',
//         dataType: 'binary',
//         async: false,
//         success: function (data) {
//           console.log("HELLO")
//           console.log(data); //ArrayBuffer
//           console.log(new Blob([data])) // Blob
//         }
//       }).then(console.log("KEEP CODING BELOW HERE"))
// }


// function getjson() {
//   $.ajax({
//         url: "http://104.248.69.73:4000/tab?pdf="+pdfName,
//         type: 'GET',
//         dataType: 'blob',
//         success: function (data) {
//             console.log("JSON BELOW");
//         }
//       }).then(function(data) {
//             console.log(data);
//         })
// }


  </script>

</body>
</html>
